<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Simulasi Investasi (Realtime)</title>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<style>
body { font-family:'Segoe UI', sans-serif; background:#f0f2f5; margin:0; padding:0;}
header { background:#1E88E5; color:white; padding:10px 15px; position:relative; text-align:center;}
header h1{ margin:0; font-size:1.5em; }
#usernameDisplay{position:absolute; left:10px; top:10px; font-size:0.9em; font-weight:bold;}
.logout-btn{position:absolute; right:10px; top:10px; padding:3px 8px; font-size:0.8em; background:#9E9E9E; color:white; border:none; border-radius:5px; cursor:pointer;}
.container { max-width:600px; margin:20px auto; background:white; border-radius:10px; padding:20px; box-shadow:0 0 15px rgba(0,0,0,0.1);}
h2{text-align:center; margin-top:0; margin-bottom:10px;}
.balance {font-size:1.5em; text-align:center; margin-bottom:20px; font-weight:bold;}
input, select, button { width:100%; padding:10px; margin-bottom:10px; border-radius:5px; border:1px solid #ccc; box-sizing:border-box;}
button { cursor:pointer; font-weight:bold; }
.reload-btn{background:#FF9800; color:white; border:none;}
.invest-btn{background:#4CAF50; color:white; border:none;}
.withdraw-btn{background:#f44336; color:white; border:none;}
.history-btn{background:#607D8B; color:white; border:none; margin-bottom:15px;}
.investment-card { border:1px solid #ddd; border-radius:8px; padding:10px; margin-bottom:10px; background:#fafafa;}
.hidden{display:none;}
ul{padding-left:20px;}
</style>
</head>
<body>

<header>
<div id="usernameDisplay"></div>
<h1>Simulasi Investasi (Realtime)</h1>
<button class="logout-btn" onclick="logout()">Logout</button>
</header>

<div class="container">
<div class="balance" id="balance">Rp 0</div>

<h2>Isi Ulang</h2>
<input type="number" id="reloadAmount" placeholder="Masukkan nominal isi ulang (misal 50000)">
<button class="reload-btn" onclick="reloadBalance()">Isi Ulang</button>

<h2>Penarikan</h2>
<input type="text" id="withdrawName" placeholder="Nama pemilik akun">
<input type="text" id="withdrawEwallet" placeholder="Jenis eWallet (OVO, DANA, dll)">
<input type="text" id="withdrawNumber" placeholder="Nomor akun eWallet">
<input type="number" id="withdrawAmount" placeholder="Nominal penarikan (maks 3x/hari, minimal 20rb)">
<button class="withdraw-btn" onclick="withdraw()">Ajukan Penarikan</button>

<button class="history-btn" onclick="toggleHistory()">Tampilkan / Sembunyikan Riwayat</button>

<div id="historyContainer" class="hidden">
<h3>Riwayat Isi Ulang</h3>
<div id="reloadHistory"></div>
<h3>Riwayat Penarikan</h3>
<div id="withdrawHistory"></div>
<h3>Riwayat Investasi</h3>
<div id="investmentsContainer"></div>
</div>

<h2>Investasi</h2>
<input type="number" id="investAmount" placeholder="Masukkan nominal investasi minimal 10.000">
<select id="investDuration">
  <option value="1">Harian (5x)</option>
  <option value="7">Mingguan (10x)</option>
  <option value="30" selected>Bulanan (30x)</option>
  <option value="365">Tahunan (50x)</option>
</select>
<button class="invest-btn" onclick="invest()">Mulai Investasi</button>
</div>

<script>
// ===================
// FIREBASE
// ===================
const firebaseConfig = {
  apiKey: "AIzaSyDAkDFS1Mp8zAJvXq8P8SkzJnmbZRyHKaY",
  authDomain: "testingsaja-bb474.firebaseapp.com",
  databaseURL: "https://testingsaja-bb474-default-rtdb.firebaseio.com",
  projectId: "testingsaja-bb474",
  storageBucket: "testingsaja-bb474.appspot.com",
  messagingSenderId: "1068578641763",
  appId: "1:1068578641763:web:3832c9485c5092df3b6556",
  measurementId: "G-PF9N37F8V9"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();
const usersRef = db.ref('users');

// ===================
// INIT
// ===================
let currentUser = localStorage.getItem('currentUser');
if(!currentUser){ window.location.href="login.html"; }

let user = null;

// ambil data realtime
usersRef.child(currentUser).on('value', snapshot=>{
  user = snapshot.val() || {balance:0, investments:[], reloadHistory:[], withdrawHistory:[], dailyWithdraw:{}};
  renderAll();
});

// ===================
// FUNGSI UTAMA
// ===================
function saveUser(){ usersRef.child(currentUser).set(user); }

function updateBalance(){
  document.getElementById('balance').innerText = "Rp "+Math.floor(user.balance).toLocaleString('id-ID');
}

function reloadBalance(){
  let amount = parseInt(document.getElementById('reloadAmount').value);
  if(!amount || amount<1000){ alert("Minimal isi ulang 1.000"); return;}
  user.reloadHistory.push({amount, date:new Date().toLocaleString('id-ID'), status:"Proses"});
  saveUser();
  window.open(`https://wa.me/6285122173013?text=Halo, saya ingin isi ulang saldo Rp ${amount.toLocaleString('id-ID')}`,"_blank");
  document.getElementById('reloadAmount').value='';
  renderHistory();
}

function withdraw(){
  let name = document.getElementById('withdrawName').value.trim();
  let ewallet = document.getElementById('withdrawEwallet').value.trim();
  let number = document.getElementById('withdrawNumber').value.trim();
  let amount = parseInt(document.getElementById('withdrawAmount').value);
  if(!name || !ewallet || !number || !amount){ alert("Lengkapi semua form!"); return; }

  let today = new Date().toLocaleDateString();
  user.dailyWithdraw[today] = user.dailyWithdraw[today] || 0;
  if(user.dailyWithdraw[today] >= 3){ alert("Maksimal 3 penarikan per hari!"); return;}
  if(amount < 20000){ alert("Minimal penarikan 20.000!"); return;}
  
  user.withdrawHistory.push({name, ewallet, number, amount, date:new Date().toLocaleString('id-ID'), status:"Proses"});
  user.dailyWithdraw[today]++;
  saveUser();
  alert("Penarikan diajukan!");
  renderHistory();
}

function toggleHistory(){
  document.getElementById('historyContainer').classList.toggle('hidden');
  renderHistory();
}

function renderHistory(){
  document.getElementById('reloadHistory').innerHTML = "<ul>"+user.reloadHistory.map(a=>`<li>Rp ${a.amount.toLocaleString('id-ID')} - ${a.date} - ${a.status}</li>`).join('')+"</ul>";
  document.getElementById('withdrawHistory').innerHTML = "<ul>"+user.withdrawHistory.map(a=>`<li>${a.name} - ${a.ewallet} (${a.number}) Rp ${a.amount.toLocaleString('id-ID')} - ${a.date} - ${a.status}</li>`).join('')+"</ul>";
  renderInvestments();
}

function invest(){
  let amount = parseInt(document.getElementById('investAmount').value);
  let duration = parseInt(document.getElementById('investDuration').value);
  if(!amount || amount<10000){ alert("Minimal investasi 10.000!"); return;}
  if(amount>user.balance){ alert("Saldo tidak cukup!"); return;}
  let multiplier = {1:5,7:10,30:30,365:50}[duration];
  user.balance -= amount;
  let start = Date.now();
  let end = start + duration*86400000;
  let investments = user.investments || [];
  investments.push({amount, start, end, profit:amount*multiplier, claimed:0, durationDays:duration});
  user.investments = investments;
  saveUser();
  updateBalance();
  renderInvestments();
}

function renderInvestments(){
  let now = Date.now();
  let container = document.getElementById('investmentsContainer');
  container.innerHTML = '';
  (user.investments||[]).forEach((inv,i)=>{
    let status = now>=inv.end ? "Selesai" : "Berjalan";
    container.innerHTML += `
    <div class="investment-card">
      <p><strong>Investasi ${i+1}</strong></p>
      <p>Nominal: Rp ${inv.amount.toLocaleString('id-ID')}</p>
      <p>Durasi: ${inv.durationDays} hari</p>
      <p>Status: ${status}</p>
      <p>Total Profit: Rp ${inv.profit.toLocaleString('id-ID')}</p>
    </div>`;
  });
}

function logout(){
  localStorage.removeItem('currentUser');
  window.location.href="login.html";
}

function renderAll(){
  document.getElementById('usernameDisplay').innerText = currentUser;
  updateBalance();
  renderHistory();
}

setInterval(()=>{
  let now = Date.now();
  (user.investments||[]).forEach((inv)=>{
    if(now<inv.end){
      let total = inv.profit;
      let elapsed = (now - inv.start) / (inv.end - inv.start);
      inv.claimed = total * elapsed;
    } else inv.claimed = inv.profit;
  });
  saveUser();
},2000);

</script>
</body>
</html>
